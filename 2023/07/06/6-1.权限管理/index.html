<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>BeiBei-Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="BeiBei-Blog"><meta name="msapplication-TileImage" content="https://moon-sea.oss-cn-shanghai.aliyuncs.com/blog_images/head.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="BeiBei-Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="# 云尚办公系统：权限管理 # 一、权限管理 # 1、权限管理介绍 每个系统的权限功能都不尽相同，各有其自身的业务特点，对权限管理的设计也都各有特色。不过不管是怎样的权限设计，大致可归为三种：页面权限 (菜单级)、操作权限（按钮级）、数据权限。当前系统只是讲解：菜单权限与按钮权限的控制。 # 1.1、菜单权限 菜单权限就是对页面的控制，就是有这个权限的用户才能访问这个页面，没这个权限的用户就无法访"><meta property="og:type" content="blog"><meta property="og:title" content="BeiBei-Blog"><meta property="og:url" content="http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/"><meta property="og:site_name" content="BeiBei-Blog"><meta property="og:description" content="# 云尚办公系统：权限管理 # 一、权限管理 # 1、权限管理介绍 每个系统的权限功能都不尽相同，各有其自身的业务特点，对权限管理的设计也都各有特色。不过不管是怎样的权限设计，大致可归为三种：页面权限 (菜单级)、操作权限（按钮级）、数据权限。当前系统只是讲解：菜单权限与按钮权限的控制。 # 1.1、菜单权限 菜单权限就是对页面的控制，就是有这个权限的用户才能访问这个页面，没这个权限的用户就无法访"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220606155704023.png"><meta property="og:image" content="http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220606160034229.png"><meta property="og:image" content="http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/3402e929-2225-4c64-8f2e-4471b63366d0.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/20201231155747261.png"><meta property="og:image" content="http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/assets%5Cimage-20230206104938580.png"><meta property="og:image" content="http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220606095319741.png"><meta property="og:image" content="http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220607103826495.png"><meta property="og:image" content="http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220620115942257.png"><meta property="article:published_time" content="2023-07-06T08:39:47.626Z"><meta property="article:modified_time" content="2023-02-07T07:08:35.973Z"><meta property="article:author" content="John Doe"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220606155704023.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/"},"headline":"BeiBei-Blog","image":["http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220606155704023.png","http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220606160034229.png","http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/3402e929-2225-4c64-8f2e-4471b63366d0.png","https://img-blog.csdnimg.cn/20201231155747261.png","http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/assets%5Cimage-20230206104938580.png","http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220606095319741.png","http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220607103826495.png","http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220620115942257.png"],"datePublished":"2023-07-06T08:39:47.626Z","dateModified":"2023-02-07T07:08:35.973Z","author":{"@type":"Person","name":"John Doe"},"publisher":{"@type":"Organization","name":"BeiBei-Blog","logo":{"@type":"ImageObject","url":"https://moon-sea.oss-cn-shanghai.aliyuncs.com/blog_images/head.png"}},"description":"# 云尚办公系统：权限管理 # 一、权限管理 # 1、权限管理介绍 每个系统的权限功能都不尽相同，各有其自身的业务特点，对权限管理的设计也都各有特色。不过不管是怎样的权限设计，大致可归为三种：页面权限 (菜单级)、操作权限（按钮级）、数据权限。当前系统只是讲解：菜单权限与按钮权限的控制。 # 1.1、菜单权限 菜单权限就是对页面的控制，就是有这个权限的用户才能访问这个页面，没这个权限的用户就无法访"}</script><link rel="canonical" href="http://example.com/2023/07/06/6-1.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/"><link rel="icon" href="https://moon-sea.oss-cn-shanghai.aliyuncs.com/blog_images/head.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://moon-sea.oss-cn-shanghai.aliyuncs.com/blog_images/head.png" alt="BeiBei-Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">文章列表</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zhengyaok"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-07-06T08:39:47.626Z" title="2023/7/6 下午4:39:47">2023-07-06</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-02-07T07:08:35.973Z" title="2023/2/7 下午3:08:35">2023-02-07</time></span><span class="level-item">an hour read (About 9738 words)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><div class="content"><h1 id="云尚办公系统权限管理"><a class="markdownIt-Anchor" href="#云尚办公系统权限管理">#</a> 云尚办公系统：权限管理</h1>
<h2 id="一-权限管理"><a class="markdownIt-Anchor" href="#一-权限管理">#</a> 一、权限管理</h2>
<h3 id="1-权限管理介绍"><a class="markdownIt-Anchor" href="#1-权限管理介绍">#</a> 1、权限管理介绍</h3>
<p>每个系统的权限功能都不尽相同，各有其自身的业务特点，对权限管理的设计也都各有特色。不过不管是怎样的权限设计，大致可归为三种：<strong>页面权限 (菜单级)、操作权限（按钮级）、数据权限</strong>。当前系统只是讲解：菜单权限与按钮权限的控制。</p>
<h4 id="11-菜单权限"><a class="markdownIt-Anchor" href="#11-菜单权限">#</a> 1.1、菜单权限</h4>
<p>菜单权限就是对页面的控制，就是有这个权限的用户才能访问这个页面，没这个权限的用户就无法访问，它是以整个页面为维度，对权限的控制并没有那么细，所以是一种<strong>粗颗粒权限</strong>。</p>
<p><img src="images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220606155704023.png" alt="image-20220606155704023"></p>
<h4 id="12-按钮权限"><a class="markdownIt-Anchor" href="#12-按钮权限">#</a> 1.2、按钮权限</h4>
<p>按钮权限就是将页面的<strong>操作</strong>视为资源，比如删除操作，有些人可以操作有些人不能操作。对于后端来说，操作就是一个接口。于前端来说，操作往往是一个按钮，是一种<strong>细颗粒权限</strong>。</p>
<p><img src="images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220606160034229.png" alt="image-20220606160034229"></p>
<h4 id="13-权限管理设计思路"><a class="markdownIt-Anchor" href="#13-权限管理设计思路">#</a> 1.3、权限管理设计思路</h4>
<p>前面我们讲解了用户管理、角色管理及菜单管理，我们把菜单权限分配给角色，把角色分配给用户，那么用户就拥有了角色的所有权限（权限包含：菜单权限与按钮权限）。</p>
<p>接下来需要实现这两个接口：</p>
<p>1、用户登录</p>
<p>2、登录成功根据 token 获取用户相关信息（菜单权限及按钮权限数据等）</p>
<p>用户登录我们需要用到 JWT，接下来讲解 JWT。</p>
<h3 id="2-jwt"><a class="markdownIt-Anchor" href="#2-jwt">#</a> 2、JWT</h3>
<h4 id="21-jwt介绍"><a class="markdownIt-Anchor" href="#21-jwt介绍">#</a> 2.1、JWT 介绍</h4>
<p>JWT 是 JSON Web Token 的缩写，即 JSON Web 令牌，是一种自包含令牌。 是为了在网络应用环境间传递声明而执行的一种基于 JSON 的开放标准。</p>
<p>JWT 的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源。比如用在用户登录上。</p>
<p>JWT 最重要的作用就是对 token 信息的防伪作用。</p>
<h4 id="22-jwt令牌的组成"><a class="markdownIt-Anchor" href="#22-jwt令牌的组成">#</a> 2.2、JWT 令牌的组成</h4>
<p>一个 JWT 由三个部分组成：<strong>JWT 头、有效载荷、签名哈希</strong><br>
最后由这三者组合进行 base64url 编码得到 JWT</p>
<p>典型的，一个 JWT 看起来如下图：该对象为一个很长的字符串，字符之间通过 &quot;.&quot; 分隔符分为三个子串。<br>
<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a></p>
<p><img src="images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/3402e929-2225-4c64-8f2e-4471b63366d0.png" alt="3402e929-2225-4c64-8f2e-4471b63366d0"></p>
<p><strong>JWT 头</strong></p>
<p>JWT 头部分是一个描述 JWT 元数据的 JSON 对象，通常如下所示。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;,</span><br><span class="line">  &quot;typ&quot;: &quot;JWT&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的代码中，alg 属性表示签名使用的算法，默认为 HMAC SHA256（写为 HS256）；</p>
<p>typ 属性表示令牌的类型，JWT 令牌统一写为 JWT。</p>
<p>最后，使用 Base64 URL 算法将上述 JSON 对象转换为字符串保存。</p>
<p><strong>有效载荷</strong></p>
<p>有效载荷部分，是 JWT 的主体内容部分，也是一个 JSON 对象，包含需要传递的数据。 JWT 指定七个默认字段供选择。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iss: jwt签发者</span><br><span class="line">sub: 主题</span><br><span class="line">aud: 接收jwt的一方</span><br><span class="line">exp: jwt的过期时间，这个过期时间必须要大于签发时间</span><br><span class="line">nbf: 定义在什么时间之前，该jwt都是不可用的.</span><br><span class="line">iat: jwt的签发时间</span><br><span class="line">jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Helen&quot;,</span><br><span class="line">  &quot;role&quot;: &quot;editor&quot;,</span><br><span class="line">  &quot;avatar&quot;: &quot;helen.jpg&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请注意，默认情况下 JWT 是未加密的，任何人都可以解读其内容，因此不要构建隐私信息字段，存放保密信息，以防止信息泄露。</p>
<p>JSON 对象也使用 Base64 URL 算法转换为字符串保存。</p>
<p><strong>签名哈希</strong></p>
<p>签名哈希部分是对上面两部分数据签名，通过指定的算法生成哈希，以确保数据不会被篡改。</p>
<p>首先，需要指定一个密码（secret）。该密码仅仅为保存在服务器中，并且不能向用户公开。然后，使用标头中指定的签名算法（默认情况下为 HMAC SHA256）根据以下公式生成签名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(claims), secret)    ==&gt;   签名hash</span><br></pre></td></tr></table></figure>
<p>在计算出签名哈希后，JWT 头，有效载荷和签名哈希的三个部分组合成一个字符串，每个部分用 &quot;.&quot; 分隔，就构成整个 JWT 对象。</p>
<p><strong>Base64URL 算法</strong></p>
<p>如前所述，JWT 头和有效载荷序列化的算法都用到了 Base64URL。该算法和常见 Base64 算法类似，稍有差别。</p>
<p>作为令牌的 JWT 可以放在 URL 中（例如 api.example/?token=xxx）。 Base64 中用的三个字符是 &quot;+“，”/“和”=“，由于在 URL 中有特殊含义，因此 Base64URL 中对他们做了替换：”=“去掉，”+“用”-“替换，”/“用”_&quot; 替换，这就是 Base64URL 算法。</p>
<h4 id="23-项目集成jwt"><a class="markdownIt-Anchor" href="#23-项目集成jwt">#</a> 2.3、项目集成 JWT</h4>
<p>操作模块：common-util</p>
<h5 id="231-引入依赖"><a class="markdownIt-Anchor" href="#231-引入依赖">#</a> 2.3.1、 引入依赖</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="232-添加jwt帮助类"><a class="markdownIt-Anchor" href="#232-添加jwt帮助类">#</a> 2.3.2、 添加 JWT 帮助类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.common.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtHelper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">tokenExpiration</span> <span class="operator">=</span> <span class="number">365</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">tokenSignKey</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createToken</span><span class="params">(Long userId, String username)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setSubject(<span class="string">&quot;AUTH-USER&quot;</span>)</span><br><span class="line">                .setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + tokenExpiration))</span><br><span class="line">                .claim(<span class="string">&quot;userId&quot;</span>, userId)</span><br><span class="line">                .claim(<span class="string">&quot;username&quot;</span>, username)</span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, tokenSignKey)</span><br><span class="line">                .compressWith(CompressionCodecs.GZIP)</span><br><span class="line">                .compact();</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">getUserId</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(token)) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            Jws&lt;Claims&gt; claimsJws = Jwts.parser().setSigningKey(tokenSignKey).parseClaimsJws(token);</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> claimsJws.getBody();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">userId</span> <span class="operator">=</span> (Integer) claims.get(<span class="string">&quot;userId&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> userId.longValue();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getUsername</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(token)) <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            Jws&lt;Claims&gt; claimsJws = Jwts.parser().setSigningKey(tokenSignKey).parseClaimsJws(token);</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> claimsJws.getBody();</span><br><span class="line">            <span class="keyword">return</span> (String) claims.get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JwtHelper.createToken(<span class="number">1L</span>, <span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        System.out.println(token);</span><br><span class="line">        System.out.println(JwtHelper.getUserId(token));</span><br><span class="line">        System.out.println(JwtHelper.getUsername(token));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-用户登录"><a class="markdownIt-Anchor" href="#3-用户登录">#</a> 3、用户登录</h3>
<h4 id="31-修改登录方法"><a class="markdownIt-Anchor" href="#31-修改登录方法">#</a> 3.1、修改登录方法</h4>
<p>修改 IndexController 类登录方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> SysUserService sysUserService;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;登录&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> LoginVo loginVo)</span> &#123;</span><br><span class="line">    <span class="type">SysUser</span> <span class="variable">sysUser</span> <span class="operator">=</span> sysUserService.getByUsername(loginVo.getUsername());</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == sysUser) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(<span class="number">201</span>,<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!MD5.encrypt(loginVo.getPassword()).equals(loginVo.getPassword())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(<span class="number">201</span>,<span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(sysUser.getStatus().intValue() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(<span class="number">201</span>,<span class="string">&quot;用户被禁用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;token&quot;</span>, JwtHelper.createToken(sysUser.getId(), sysUser.getUsername()));</span><br><span class="line">    <span class="keyword">return</span> Result.ok(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="32-添加service接口及实现"><a class="markdownIt-Anchor" href="#32-添加service接口及实现">#</a> 3.2、添加 service 接口及实现</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SysUser <span class="title function_">getByUsername</span><span class="params">(String username)</span>;</span><br></pre></td></tr></table></figure>
<p>接口实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SysUser <span class="title function_">getByUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">this</span>.getOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;SysUser&gt;().eq(SysUser::getUsername, username));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-获取用户信息"><a class="markdownIt-Anchor" href="#4-获取用户信息">#</a> 4、获取用户信息</h3>
<p>接口数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;roles&quot;</span>,<span class="string">&quot;[admin]&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;avatar&quot;</span>,<span class="string">&quot;https://oss.aliyuncs.com/aliyun_id_photo_bucket/default_handsome.jpg&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;buttons&quot;</span>, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">map.put(<span class="string">&quot;routers&quot;</span>, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br></pre></td></tr></table></figure>
<p>说明：主要是获取当前登录用户的菜单权限及按钮权限数据</p>
<h4 id="41-获取用户菜单权限"><a class="markdownIt-Anchor" href="#41-获取用户菜单权限">#</a> 4.1、获取用户菜单权限</h4>
<p>说明：获取菜单权限数据，我们要将菜单数据构建成路由数据结构</p>
<h5 id="411-定义接口"><a class="markdownIt-Anchor" href="#411-定义接口">#</a> 4.1.1、定义接口</h5>
<p>SysMenuService 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户菜单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;RouterVo&gt; <span class="title function_">findUserMenuList</span><span class="params">(Long userId)</span>;</span><br></pre></td></tr></table></figure>
<h5 id="412-接口实现"><a class="markdownIt-Anchor" href="#412-接口实现">#</a> 4.1.2、接口实现</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;RouterVo&gt; <span class="title function_">findUserMenuList</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">    <span class="comment">//超级管理员admin账号id为：1</span></span><br><span class="line">    List&lt;SysMenu&gt; sysMenuList = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (userId.longValue() == <span class="number">1</span>) &#123;</span><br><span class="line">        sysMenuList = <span class="built_in">this</span>.list(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;SysMenu&gt;().eq(SysMenu::getStatus, <span class="number">1</span>).orderByAsc(SysMenu::getSortValue));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sysMenuList = sysMenuMapper.findListByUserId(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//构建树形数据</span></span><br><span class="line">    List&lt;SysMenu&gt; sysMenuTreeList = MenuHelper.buildTree(sysMenuList);</span><br><span class="line"></span><br><span class="line">    List&lt;RouterVo&gt; routerVoList = <span class="built_in">this</span>.buildMenus(sysMenuTreeList);</span><br><span class="line">    <span class="keyword">return</span> routerVoList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据菜单构建路由</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> menus</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;RouterVo&gt; <span class="title function_">buildMenus</span><span class="params">(List&lt;SysMenu&gt; menus)</span> &#123;</span><br><span class="line">    List&lt;RouterVo&gt; routers = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;RouterVo&gt;();</span><br><span class="line">    <span class="keyword">for</span> (SysMenu menu : menus) &#123;</span><br><span class="line">        <span class="type">RouterVo</span> <span class="variable">router</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RouterVo</span>();</span><br><span class="line">        router.setHidden(<span class="literal">false</span>);</span><br><span class="line">        router.setAlwaysShow(<span class="literal">false</span>);</span><br><span class="line">        router.setPath(getRouterPath(menu));</span><br><span class="line">        router.setComponent(menu.getComponent());</span><br><span class="line">        router.setMeta(<span class="keyword">new</span> <span class="title class_">MetaVo</span>(menu.getName(), menu.getIcon()));</span><br><span class="line">        List&lt;SysMenu&gt; children = menu.getChildren();</span><br><span class="line">        <span class="comment">//如果当前是菜单，需将按钮对应的路由加载出来，如：“角色授权”按钮对应的路由在“系统管理”下面</span></span><br><span class="line">        <span class="keyword">if</span>(menu.getType().intValue() == <span class="number">1</span>) &#123;</span><br><span class="line">            List&lt;SysMenu&gt; hiddenMenuList = children.stream().filter(item -&gt; !StringUtils.isEmpty(item.getComponent())).collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">for</span> (SysMenu hiddenMenu : hiddenMenuList) &#123;</span><br><span class="line">                <span class="type">RouterVo</span> <span class="variable">hiddenRouter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RouterVo</span>();</span><br><span class="line">                hiddenRouter.setHidden(<span class="literal">true</span>);</span><br><span class="line">                hiddenRouter.setAlwaysShow(<span class="literal">false</span>);</span><br><span class="line">                hiddenRouter.setPath(getRouterPath(hiddenMenu));</span><br><span class="line">                hiddenRouter.setComponent(hiddenMenu.getComponent());</span><br><span class="line">                hiddenRouter.setMeta(<span class="keyword">new</span> <span class="title class_">MetaVo</span>(hiddenMenu.getName(), hiddenMenu.getIcon()));</span><br><span class="line">                routers.add(hiddenRouter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(children)) &#123;</span><br><span class="line">                <span class="keyword">if</span>(children.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    router.setAlwaysShow(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                router.setChildren(buildMenus(children));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        routers.add(router);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> routers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取路由地址</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> menu 菜单信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 路由地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRouterPath</span><span class="params">(SysMenu menu)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">routerPath</span> <span class="operator">=</span> <span class="string">&quot;/&quot;</span> + menu.getPath();</span><br><span class="line">    <span class="keyword">if</span>(menu.getParentId().intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">        routerPath = menu.getPath();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> routerPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="413-添加mapper接口"><a class="markdownIt-Anchor" href="#413-添加mapper接口">#</a> 4.1.3、添加 mapper 接口</h5>
<p>SysMenuMapper 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;SysMenu&gt; <span class="title function_">findListByUserId</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> Long userId)</span>;</span><br></pre></td></tr></table></figure>
<h5 id="414-添加xml方法"><a class="markdownIt-Anchor" href="#414-添加xml方法">#</a> 4.1.4、添加 xml 方法</h5>
<p>新建 SysMenuMapper.xml 文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta"><span class="keyword">PUBLIC</span> <span class="string">&quot;-//ibatis.apache.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta"><span class="string">&quot;http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.atguigu.system.mapper.SysMenuMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;sysMenuMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.atguigu.model.system.SysMenu&quot;</span> <span class="attr">autoMapping</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">&lt;!-- 用于select查询公用抽取的列 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;columns&quot;</span>&gt;</span></span><br><span class="line">      m.id,m.parent_id,m.name,m.type,m.path,m.component,m.perms,m.icon,m.sort_value,m.status,m.create_time,m.update_time,m.is_deleted</span><br><span class="line">   <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findListByUserId&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;sysMenuMap&quot;</span>&gt;</span></span><br><span class="line">      select</span><br><span class="line">      distinct <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;columns&quot;</span> /&gt;</span></span><br><span class="line">      from sys_menu m</span><br><span class="line">      inner join sys_role_menu rm on rm.menu_id = m.id</span><br><span class="line">      inner join sys_user_role ur on ur.role_id = rm.role_id</span><br><span class="line">      where</span><br><span class="line">      ur.user_id = #&#123;userId&#125;</span><br><span class="line">      and m.status = 1</span><br><span class="line">      and rm.is_deleted = 0</span><br><span class="line">      and ur.is_deleted = 0</span><br><span class="line">      and m.is_deleted = 0</span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="42-获取用户按钮权限"><a class="markdownIt-Anchor" href="#42-获取用户按钮权限">#</a> 4.2、获取用户按钮权限</h4>
<p>说明：只需要获取按钮标识即可</p>
<h5 id="411-定义接口-2"><a class="markdownIt-Anchor" href="#411-定义接口-2">#</a> 4.1.1、定义接口</h5>
<p>SysMenuService 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户按钮权限</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;String&gt; <span class="title function_">findUserPermsList</span><span class="params">(Long userId)</span>;</span><br></pre></td></tr></table></figure>
<h5 id="412-接口实现-2"><a class="markdownIt-Anchor" href="#412-接口实现-2">#</a> 4.1.2、接口实现</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;String&gt; <span class="title function_">findUserPermsList</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">    <span class="comment">//超级管理员admin账号id为：1</span></span><br><span class="line">    List&lt;SysMenu&gt; sysMenuList = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (userId.longValue() == <span class="number">1</span>) &#123;</span><br><span class="line">        sysMenuList = <span class="built_in">this</span>.list(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;SysMenu&gt;().eq(SysMenu::getStatus, <span class="number">1</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sysMenuList = sysMenuMapper.findListByUserId(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; permsList = sysMenuList.stream().filter(item -&gt; item.getType() == <span class="number">2</span>).map(item -&gt; item.getPerms()).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> permsList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="43-修改controller方法"><a class="markdownIt-Anchor" href="#43-修改controller方法">#</a> 4.3、修改 Controller 方法</h4>
<p>IndexController 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;获取用户信息&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;info&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">info</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> JwtHelper.getUsername(request.getHeader(<span class="string">&quot;token&quot;</span>));</span><br><span class="line">    Map&lt;String, Object&gt; map = sysUserService.getUserInfo(username);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="43-定义service接口"><a class="markdownIt-Anchor" href="#43-定义service接口">#</a> 4.3、定义 service 接口</h4>
<p>SysUserService 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户名获取用户登录信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Map&lt;String, Object&gt; <span class="title function_">getUserInfo</span><span class="params">(String username)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="44-service接口实现"><a class="markdownIt-Anchor" href="#44-service接口实现">#</a> 4.4、service 接口实现</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> SysMenuService sysMenuService;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getUserInfo</span><span class="params">(String username)</span> &#123;</span><br><span class="line">   Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">   <span class="type">SysUser</span> <span class="variable">sysUser</span> <span class="operator">=</span> <span class="built_in">this</span>.getByUsername(username);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//根据用户id获取菜单权限值</span></span><br><span class="line">   List&lt;RouterVo&gt; routerVoList = sysMenuService.findUserMenuList(sysUser.getId());</span><br><span class="line">   <span class="comment">//根据用户id获取用户按钮权限</span></span><br><span class="line">   List&lt;String&gt; permsList = sysMenuService.findUserPermsList(sysUser.getId());</span><br><span class="line"></span><br><span class="line">   result.put(<span class="string">&quot;name&quot;</span>, sysUser.getName());</span><br><span class="line">   result.put(<span class="string">&quot;avatar&quot;</span>, <span class="string">&quot;https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif&quot;</span>);</span><br><span class="line">   <span class="comment">//当前权限控制使用不到，我们暂时忽略</span></span><br><span class="line">   result.put(<span class="string">&quot;roles&quot;</span>,  <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;());</span><br><span class="line">   result.put(<span class="string">&quot;buttons&quot;</span>, permsList);</span><br><span class="line">   result.put(<span class="string">&quot;routers&quot;</span>, routerVoList);</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-前端对接"><a class="markdownIt-Anchor" href="#5-前端对接">#</a> 5、前端对接</h3>
<p>参考前端对接文档：《前端权限对接文档》</p>
<p>可直接引入前端项目完整代码</p>
<h3 id="6-总结"><a class="markdownIt-Anchor" href="#6-总结">#</a> 6、总结</h3>
<p>当前我们已经实现前端菜单及按钮的权限控制，服务器端还没加任何控制，那么服务器端怎么控制呢？其实很简单，就是要在页面按钮对应的 controller 方法上面加对应的权限控制，即在进入 controller 方法前判断当前用户是否有访问权限。</p>
<p>怎么实现呢？如果我们自己实现，那么肯定想到的就是 Fillter 加 Aop 就可以实现，有现成的开源技术框架吗？答案是肯定的，如：Spring Security、Shiro 等一系列开源框架可供选择。</p>
<h2 id="二-spring-security介绍"><a class="markdownIt-Anchor" href="#二-spring-security介绍">#</a> 二、Spring Security 介绍</h2>
<h3 id="1-spring-security简介"><a class="markdownIt-Anchor" href="#1-spring-security简介">#</a> 1、Spring Security 简介</h3>
<p>Spring 是非常流行和成功的 Java 应用开发框架，Spring Security 正是 Spring 家族中的成员。Spring Security 基于 Spring 框架，提供了一套 Web 应用安全性的完整解决方案。</p>
<p>正如你可能知道的关于安全方面的两个核心功能是 “<strong>认证</strong>” 和 “<strong>授权</strong>”，一般来说，Web 应用的安全性包括 ** 用户认证（Authentication）和用户授权（Authorization）** 两个部分，这两点也是 SpringSecurity 重要核心功能。</p>
<p>（1）用户认证指的是：验证某个用户是否为系统中的合法主体，也就是说用户能否访问该系统。用户认证一般要求用户提供用户名和密码，系统通过校验用户名和密码来完成认证过程。</p>
<p><strong>通俗点说就是系统认为用户是否能登录</strong></p>
<p>（2）用户授权指的是验证某个用户是否有权限执行某个操作。在一个系统中，不同用户所具有的权限是不同的。比如对一个文件来说，有的用户只能进行读取，而有的用户可以进行修改。一般来说，系统会为不同的用户分配不同的角色，而每个角色则对应一系列的权限。</p>
<p><strong>通俗点讲就是系统判断用户是否有权限去做某些事情。</strong></p>
<h3 id="2-同款产品对比"><a class="markdownIt-Anchor" href="#2-同款产品对比">#</a> 2、同款产品对比</h3>
<h4 id="31-spring-security"><a class="markdownIt-Anchor" href="#31-spring-security">#</a> 3.1、Spring Security</h4>
<p>Spring 技术栈的组成部分。</p>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></p>
<p>通过提供完整可扩展的认证和授权支持保护你的应用程序。</p>
<p><strong>SpringSecurity 特点：</strong></p>
<p>⚫ 和 Spring 无缝整合。</p>
<p>⚫ 全面的权限控制。</p>
<p>⚫ 专门为 Web 开发而设计。</p>
<p>​	◼旧版本不能脱离 Web 环境使用。</p>
<p>​	◼新版本对整个框架进行了分层抽取，分成核心模块和 Web 模块。单独引入核心模块就可以脱离 Web 环境。</p>
<p>⚫ 重量级。</p>
<h4 id="32-shiro"><a class="markdownIt-Anchor" href="#32-shiro">#</a> 3.2、 Shiro</h4>
<p>Apache 旗下的轻量级权限控制框架。</p>
<p><strong>特点：</strong></p>
<p>⚫ 轻量级。Shiro 主张的理念是把复杂的事情变简单。针对对性能有更高要求的互联网应用有更好表现。</p>
<p>⚫ 通用性。</p>
<p>​	◼好处：不局限于 Web 环境，可以脱离 Web 环境使用。</p>
<p>​	◼缺陷：在 Web 环境下一些特定的需求需要手动编写代码定制。</p>
<p>Spring Security 是 Spring 家族中的一个安全管理框架，实际上，在 Spring Boot 出现之前，Spring Security 就已经发展了多年了，但是使用的并不多，安全管理这个领域，一直是 Shiro 的天下。</p>
<p>相对于 Shiro，在 SSM 中整合 Spring Security 都是比较麻烦的操作，所以，Spring Security 虽然功能比 Shiro 强大，但是使用反而没有 Shiro 多（Shiro 虽然功能没有 Spring Security 多，但是对于大部分项目而言，Shiro 也够用了）。自从有了 Spring Boot 之后，Spring Boot 对于 Spring Security 提供了自动化配置方案，可以使用更少的配置来使用 Spring Security。</p>
<h2 id="三-spring-security实现权限"><a class="markdownIt-Anchor" href="#三-spring-security实现权限">#</a> 三、Spring Security 实现权限</h2>
<p>要对 Web 资源进行保护，最好的办法莫过于 Filter<br>
 要想对方法调用进行保护，最好的办法莫过于<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=AOP&amp;spm=1001.2101.3001.7020"> AOP</a>。</p>
<p>Spring Security 进行认证和鉴权的时候，就是利用的一系列的 Filter 来进行拦截的。</p>
<p><img src="https://img-blog.csdnimg.cn/20201231155747261.png" alt="img"></p>
<p>如图所示，一个请求想要访问到 API 就会从左到右经过蓝线框里的过滤器，其中<strong>绿色部分是负责认证的过滤器，蓝色部分是负责异常处理，橙色部分则是负责授权</strong>。进过一系列拦截最终访问到我们的 API。</p>
<p><img src="assets%5Cimage-20230206104938580.png" alt="image-20230206104938580"></p>
<p>这里面我们只需要重点关注两个过滤器即可： <code>UsernamePasswordAuthenticationFilter</code>  负责登录认证， <code>FilterSecurityInterceptor</code>  负责权限授权。</p>
<p>说明：<strong>Spring Security 的核心逻辑全在这一套过滤器中，过滤器里会调用各种组件完成功能，掌握了这些过滤器和组件你就掌握了 Spring Security</strong>！这个框架的使用方式就是对这些过滤器和组件进行扩展。</p>
<h3 id="1-spring-security入门"><a class="markdownIt-Anchor" href="#1-spring-security入门">#</a> 1、Spring Security 入门</h3>
<p>我们在现有的项目基础上做集成，Spring Security 权限控制部分也是公共模块，后续哪个 service 服务模块需要，直接引入即可。</p>
<p>后续我们的 Spring Cloud 微服务项目可能就基于该权限系统开发，因此我们要做好技术扩展。</p>
<h4 id="11-创建spring-security模块"><a class="markdownIt-Anchor" href="#11-创建spring-security模块">#</a> 1.1、创建 spring-security 模块</h4>
<p>在 common 模块下创建 spring-security 公共模块，创建方式如：service-util 模块</p>
<h4 id="12-添加依赖"><a class="markdownIt-Anchor" href="#12-添加依赖">#</a> 1.2、添加依赖</h4>
<p>修改 pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common-util<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Spring Security依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided <span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>说明：依赖包（spring-boot-starter-security）导入后，Spring Security 就默认提供了许多功能将整个应用给保护了起来：</p>
<p>​	1、要求经过身份验证的用户才能与应用程序进行交互</p>
<p>​	2、创建好了默认登录表单</p>
<p>​	3、生成用户名为 <code>user</code>  的随机密码并打印在控制台上</p>
<p>​	等等…</p>
<h4 id="13-添加配置类"><a class="markdownIt-Anchor" href="#13-添加配置类">#</a> 1.3、添加配置类</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span> <span class="comment">//@EnableWebSecurity是开启SpringSecurity的默认行为</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14-service-oa模块引入"><a class="markdownIt-Anchor" href="#14-service-oa模块引入">#</a> 1.4、service-oa 模块引入</h4>
<p>在 service-oa 引入权限模块，将依赖添加到 pom.mxl 文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="15-启动项目测试"><a class="markdownIt-Anchor" href="#15-启动项目测试">#</a> 1.5、启动项目测试</h4>
<p>在浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8800/admin/system/sysRole/findAll">http://localhost:8800/admin/system/sysRole/findAll</a></p>
<p>自动跳转到了登录页面</p>
<p><img src="images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220606095319741.png" alt="image-20220606095319741"></p>
<p>默认的用户名：user</p>
<p>密码在项目启动的时候在控制台会打印，<strong>注意每次启动的时候密码都回发生变化！</strong></p>
<p><img src="images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220607103826495.png" alt="image-20220607103826495"></p>
<p>输入用户名，密码，成功访问到 controller 方法并返回数据，说明 Spring Security 默认安全保护生效。</p>
<p>在实际开发中，这些默认的配置是不能满足我们需要的，我们需要扩展 Spring Security 组件，完成自定义配置，实现我们的项目需求。</p>
<h3 id="2-用户认证"><a class="markdownIt-Anchor" href="#2-用户认证">#</a> 2、用户认证</h3>
<p>用户认证流程：</p>
<p><img src="images/6.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/image-20220620115942257.png" alt="image-20220620115942257"></p>
<h4 id="21-用户认证核心组件"><a class="markdownIt-Anchor" href="#21-用户认证核心组件">#</a> 2.1、用户认证核心组件</h4>
<p>我们系统中会有许多用户，确认当前是哪个用户正在使用我们系统就是登录认证的最终目的。这里我们就提取出了一个核心概念：<strong>当前登录用户 / 当前认证用户</strong>。整个系统安全都是围绕当前登录用户展开的，这个不难理解，要是当前登录用户都不能确认了，那 A 下了一个订单，下到了 B 的账户上这不就乱套了。这一概念在 Spring Security 中的体现就是 <strong> <code>Authentication</code> </strong>，它存储了认证信息，代表当前登录用户。</p>
<p>我们在程序中如何获取并使用它呢？我们需要通过 <strong> <code>SecurityContext</code> </strong> 来获取 <code>Authentication</code> ， <code>SecurityContext</code>  就是我们的上下文对象！这个上下文对象则是交由 <strong> <code>SecurityContextHolder</code> </strong> 进行管理，你可以在程序<strong>任何地方</strong>使用它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span><br></pre></td></tr></table></figure>
<p><code>SecurityContextHolder</code>  原理非常简单，就是使用 <code>ThreadLocal</code>  来保证一个线程中传递同一个对象！</p>
<p><strong>现在我们已经知道了 Spring Security 中三个核心组件：</strong></p>
<p>​	1、 <code>Authentication</code> ：存储了认证信息，代表当前登录用户</p>
<p>​	2、 <code>SeucirtyContext</code> ：上下文对象，用来获取 <code>Authentication</code></p>
<p>​	3、 <code>SecurityContextHolder</code> ：上下文管理对象，用来在程序任何地方获取 <code>SecurityContext</code></p>
<p><strong> <code>Authentication</code>  中是什么信息呢：</strong></p>
<p>​	1、 <code>Principal</code> ：用户信息，没有认证时一般是用户名，认证后一般是用户对象</p>
<p>​	2、 <code>Credentials</code> ：用户凭证，一般是密码</p>
<p>​	3、 <code>Authorities</code> ：用户权限</p>
<h4 id="22-用户认证"><a class="markdownIt-Anchor" href="#22-用户认证">#</a> 2.2、用户认证</h4>
<p>Spring Security 是怎么进行用户认证的呢？</p>
<p><strong> <code>AuthenticationManager</code> </strong> 就是 Spring Security 用于执行身份验证的组件，只需要调用它的 <code>authenticate</code>  方法即可完成认证。Spring Security 默认的认证方式就是在 <code>UsernamePasswordAuthenticationFilter</code>  这个过滤器中进行认证的，该过滤器负责认证逻辑。</p>
<p>Spring Security 用户认证关键代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 生成一个包含账号密码的认证信息</span><br><span class="line">Authentication authenticationToken = new UsernamePasswordAuthenticationToken(username, passwrod);</span><br><span class="line">// AuthenticationManager校验这个认证信息，返回一个已认证的Authentication</span><br><span class="line">Authentication authentication = authenticationManager.authenticate(authenticationToken);</span><br><span class="line">// 将返回的Authentication存到上下文中</span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(authentication);</span><br></pre></td></tr></table></figure>
<p>下面我们来分析一下。</p>
<h5 id="221-认证接口分析"><a class="markdownIt-Anchor" href="#221-认证接口分析">#</a> 2.2.1、认证接口分析</h5>
<p><code>AuthenticationManager</code>  的校验逻辑非常简单：</p>
<p>根据用户名先查询出用户对象 (没有查到则抛出异常) 将用户对象的密码和传递过来的密码进行校验，密码不匹配则抛出异常。</p>
<p>这个逻辑没啥好说的，再简单不过了。重点是这里每一个步骤 Spring Security 都提供了组件：</p>
<p>​	1、是谁执行 <strong>根据用户名查询出用户对象</strong> 逻辑的呢？用户对象数据可以存在内存中、文件中、数据库中，你得确定好怎么查才行。这一部分就是交由 ** <code>UserDetialsService</code> ** 处理，该接口只有一个方法 <code>loadUserByUsername(String username)</code> ，通过用户名查询用户对象，默认实现是在内存中查询。</p>
<p>​	2、那查询出来的 <strong>用户对象</strong> 又是什么呢？每个系统中的用户对象数据都不尽相同，咱们需要确认我们的用户数据是啥样的才行。Spring Security 中的用户数据则是由 ** <code>UserDetails</code> ** 来体现，该接口中提供了账号、密码等通用属性。</p>
<p>​	3、<strong>对密码进行校验</strong>大家可能会觉得比较简单， <code>if、else</code>  搞定，就没必要用什么组件了吧？但框架毕竟是框架考虑的比较周全，除了 <code>if、else</code>  外还解决了密码加密的问题，这个组件就是 ** <code>PasswordEncoder</code> **，负责密码加密与校验。</p>
<p>我们可以看下 <code>AuthenticationManager</code>  校验逻辑的大概源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">...省略其他代码</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 传递过来的用户名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">    <span class="comment">// 调用UserDetailService的方法，通过用户名查询出用户对象UserDetail（查询不出来UserDetailService则会抛出异常）</span></span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> <span class="built_in">this</span>.getUserDetailsService().loadUserByUsername(username);</span><br><span class="line">    <span class="type">String</span> <span class="variable">presentedPassword</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 传递过来的密码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line">    <span class="comment">// 使用密码解析器PasswordEncoder传递过来的密码是否和真实的用户密码匹配</span></span><br><span class="line">    <span class="keyword">if</span> (!passwordEncoder.matches(password, userDetails.getPassword())) &#123;</span><br><span class="line">        <span class="comment">// 密码错误则抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="string">&quot;错误信息...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意哦，这里返回的已认证Authentication，是将整个UserDetails放进去充当Principal</span></span><br><span class="line">    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(userDetails,</span><br><span class="line">            authentication.getCredentials(), userDetails.getAuthorities());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">...省略其他代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>UserDetialsService</code> 、 <code>UserDetails</code> 、 <code>PasswordEncoder</code> ，这三个组件 Spring Security 都有默认实现，这一般是满足不了我们的实际需求的，所以这里我们自己来实现这些组件！</p>
<p><strong>下面我们就在项目里面来实现用户认证。</strong></p>
<h5 id="223-加密器passwordencoder"><a class="markdownIt-Anchor" href="#223-加密器passwordencoder">#</a> 2.2.3、加密器 PasswordEncoder</h5>
<p>加密我们项目采取 MD5 加密</p>
<p>操作模块：spring-security 模块</p>
<p><strong>自定义加密处理组件：CustomMd5PasswordEncoder</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.custom;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.util.MD5;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 密码处理</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomMd5PasswordEncoder</span> <span class="keyword">implements</span> <span class="title class_">PasswordEncoder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encode</span><span class="params">(CharSequence rawPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MD5.encrypt(rawPassword.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> encodedPassword.equals(MD5.encrypt(rawPassword.toString()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="224-用户对象userdetails"><a class="markdownIt-Anchor" href="#224-用户对象userdetails">#</a> 2.2.4、用户对象 UserDetails</h5>
<p>该接口就是我们所说的用户对象，它提供了用户的一些通用属性，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDetails</span> <span class="keyword">extends</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户权限集合（这个权限对象现在不管它，到权限时我会讲解）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">getPassword</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">getUsername</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户没过期返回true，反之则false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户没锁定返回true，反之则false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户凭据(通常为密码)没过期返回true，反之则false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户是启用状态返回true，反之则false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际开发中我们的用户属性各种各样，这些默认属性可能是满足不了，所以我们一般会自己实现该接口，然后设置好我们实际的用户实体对象。实现此接口要重写很多方法比较麻烦，我们可以继承 Spring Security 提供的 <code>org.springframework.security.core.userdetails.User</code>  类，该类实现了 <code>UserDetails</code>  接口帮我们省去了重写方法的工作：</p>
<p>操作模块：spring-security 模块</p>
<p><strong>添加 CustomUser 对象</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.custom;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.model.system.SysUser;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomUser</span> <span class="keyword">extends</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 我们自己的用户实体对象，要调取用户信息时直接获取这个实体对象。（这里我就不写get/set方法了）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SysUser sysUser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomUser</span><span class="params">(SysUser sysUser, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(sysUser.getUsername(), sysUser.getPassword(), authorities);</span><br><span class="line">        <span class="built_in">this</span>.sysUser = sysUser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SysUser <span class="title function_">getSysUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sysUser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSysUser</span><span class="params">(SysUser sysUser)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sysUser = sysUser;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="225-业务对象userdetailsservice"><a class="markdownIt-Anchor" href="#225-业务对象userdetailsservice">#</a> 2.2.5 业务对象 UserDetailsService</h5>
<p>该接口很简单只有一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据用户名获取用户对象（获取不到直接抛异常）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们实现该接口，就完成了自己的业务</p>
<p><strong>操作模块：service-oa</strong></p>
<p><strong>添加 UserDetailsServiceImpl 类，实现 UserDetailsService 接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.system.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.execption.GuiguException;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.result.ResultCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.model.system.SysUser;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.security.custom.CustomUser;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.system.service.SysUserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysUserService sysUserService;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">SysUser</span> <span class="variable">sysUser</span> <span class="operator">=</span> sysUserService.getByUsername(username);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == sysUser) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;用户名不存在！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(sysUser.getStatus().intValue() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;账号已停用&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomUser</span>(sysUser, Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AuthenticationManager</code>  校验所调用的三个组件我们就已经做好实现了！</p>
<h5 id="226-自定义用户认证接口"><a class="markdownIt-Anchor" href="#226-自定义用户认证接口">#</a> 2.2.6、自定义用户认证接口</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.fillter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.jwt.JwtHelper;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.result.ResultCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.util.ResponseUtil;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.security.custom.CustomUser;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.vo.system.LoginVo;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 登录过滤器，继承UsernamePasswordAuthenticationFilter，对用户名密码进行登录校验</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenLoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TokenLoginFilter</span><span class="params">(AuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setAuthenticationManager(authenticationManager);</span><br><span class="line">        <span class="built_in">this</span>.setPostOnly(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//指定登录接口及提交方式，可以指定任意路径</span></span><br><span class="line">        <span class="built_in">this</span>.setRequiresAuthenticationRequestMatcher(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/admin/system/index/login&quot;</span>,<span class="string">&quot;POST&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录认证</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> res</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> AuthenticationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span></span><br><span class="line">            <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">LoginVo</span> <span class="variable">loginVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().readValue(req.getInputStream(), LoginVo.class);</span><br><span class="line"></span><br><span class="line">            <span class="type">Authentication</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginVo.getUsername(), loginVo.getPassword());</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authenticationToken);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录成功</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chain</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain,</span></span><br><span class="line"><span class="params">                                            Authentication auth)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">CustomUser</span> <span class="variable">customUser</span> <span class="operator">=</span> (CustomUser) auth.getPrincipal();</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JwtHelper.createToken(customUser.getSysUser().getId(), customUser.getSysUser().getUsername());</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">        ResponseUtil.out(response, Result.ok(map));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录失败</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">unsuccessfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                              AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(e.getCause() <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            ResponseUtil.out(response, Result.build(<span class="literal">null</span>, <span class="number">204</span>, e.getMessage()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ResponseUtil.out(response, Result.build(<span class="literal">null</span>, ResultCodeEnum.LOGIN_MOBLE_ERROR));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加工具类：ResponseUtil</p>
<p>添加模块：common-util</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.common.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResponseUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">out</span><span class="params">(HttpServletResponse response, Result r)</span> &#123;</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        response.setStatus(HttpStatus.OK.value());</span><br><span class="line">        response.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mapper.writeValue(response.getWriter(), r);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="227-认证解析token"><a class="markdownIt-Anchor" href="#227-认证解析token">#</a> 2.2.7、认证解析 token</h5>
<p>因为用户登录状态在 token 中存储在客户端，所以每次请求接口请求头携带 token， 后台通过自定义 token 过滤器拦截解析 token 完成认证并填充用户信息实体。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.fillter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.jwt.JwtHelper;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.result.ResultCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.util.ResponseUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 认证解析token过滤器</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TokenAuthenticationFilter</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;uri:&quot;</span>+request.getRequestURI());</span><br><span class="line">        <span class="comment">//如果是登录接口，直接放行</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;/admin/system/index/login&quot;</span>.equals(request.getRequestURI())) &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authentication</span> <span class="operator">=</span> getAuthentication(request);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != authentication) &#123;</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ResponseUtil.out(response, Result.build(<span class="literal">null</span>, ResultCodeEnum.PERMISSION));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UsernamePasswordAuthenticationToken <span class="title function_">getAuthentication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// token置于header里</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;token:&quot;</span>+token);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">useruame</span> <span class="operator">=</span> JwtHelper.getUsername(token);</span><br><span class="line">            logger.info(<span class="string">&quot;useruame:&quot;</span>+useruame);</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(useruame)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(useruame, <span class="literal">null</span>, Collections.emptyList());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="228-配置用户认证"><a class="markdownIt-Anchor" href="#228-配置用户认证">#</a> 2.2.8、配置用户认证</h5>
<p>修改 WebSecurityConfig 配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.security.custom.CustomMd5PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.security.filter.TokenAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.security.filter.TokenLoginFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span> <span class="comment">//@EnableWebSecurity是开启SpringSecurity的默认行为</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomMd5PasswordEncoder customMd5PasswordEncoder;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 这是配置的关键，决定哪些接口开启防护，哪些接口绕过防护</span></span><br><span class="line">        http</span><br><span class="line">                <span class="comment">//关闭csrf跨站请求伪造</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line">                <span class="comment">// 开启跨域以便前端调用接口</span></span><br><span class="line">                .cors().and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                <span class="comment">// 指定某些接口不需要通过验证即可访问。登陆接口肯定是不需要认证的</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/system/index/login&quot;</span>).permitAll()</span><br><span class="line">                <span class="comment">// 这里意思是其它所有接口需要认证才能访问</span></span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">//TokenAuthenticationFilter放到UsernamePasswordAuthenticationFilter的前面，这样做就是为了除了登录的时候去查询数据库外，其他时候都用token进行认证。</span></span><br><span class="line">                .addFilterBefore(<span class="keyword">new</span> <span class="title class_">TokenAuthenticationFilter</span>(), UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">                .addFilter(<span class="keyword">new</span> <span class="title class_">TokenLoginFilter</span>(authenticationManager()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//禁用session</span></span><br><span class="line">        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 指定UserDetailService和加密器</span></span><br><span class="line">    auth.userDetailsService(userDetailsService)</span><br><span class="line">        .passwordEncoder(customMd5PasswordEncoder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置哪些请求不拦截</span></span><br><span class="line"><span class="comment">     * 排除swagger相关请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/favicon.ico&quot;</span>,<span class="string">&quot;/swagger-resources/**&quot;</span>, <span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;/v2/**&quot;</span>, <span class="string">&quot;/swagger-ui.html/**&quot;</span>, <span class="string">&quot;/doc.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<p><strong>1、我们是前后端分离项目，使用 <code>jwt</code>  生成 token ，即用户状态保存在客户端中，前后端交互通过 api 接口  <code>无session</code>  生成，所以我们不需要配置 <code>formLogin</code> ，session 禁用</strong></p>
<p><strong>2、在浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8800/admin/system/sysRole/findAll">http://localhost:8800/admin/system/sysRole/findAll</a></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;code&quot;: 209,</span><br><span class="line">    &quot;message&quot;: &quot;没有权限&quot;,</span><br><span class="line">    &quot;data&quot;: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="229-通过swagger测试登录"><a class="markdownIt-Anchor" href="#229-通过swagger测试登录">#</a> 2.2.9、通过 swagger 测试登录</h5>
<p>在相应的自定义组件设置断点，查看是否按照预期执行。</p>
<p>1、先输入正确的用户名与密码</p>
<p>2、输入错误的用户名与密码</p>
<p>结论：跟预期一致</p>
<h3 id="3-用户授权"><a class="markdownIt-Anchor" href="#3-用户授权">#</a> 3、用户授权</h3>
<p>在 SpringSecurity 中，会使用默认的 FilterSecurityInterceptor 来进行权限校验。在 FilterSecurityInterceptor 中会从 SecurityContextHolder 获取其中的<strong> Authentication</strong>，然后获取其中的权限信息。判断当前用户是否拥有访问当前资源所需的权限。</p>
<p><strong>SpringSecurity 中的 Authentication 类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Authentication</span> <span class="keyword">extends</span> <span class="title class_">Principal</span>, Serializable &#123;</span><br><span class="line">	<span class="comment">//权限数据列表</span></span><br><span class="line">    Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities();</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">getCredentials</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">getDetails</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">getPrincipal</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAuthenticated</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setAuthenticated</span><span class="params">(<span class="type">boolean</span> var1)</span> <span class="keyword">throws</span> IllegalArgumentException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前面登录时执行 loadUserByUsername 方法时，return new CustomUser (sysUser, Collections.emptyList ()); 后面的空数据对接就是返回给 Spring Security 的权限数据。</p>
<p>在 TokenAuthenticationFilter 中怎么获取权限数据呢？登录时我们把权限数据保存到 redis 中（用户名为 key，权限数据为 value 即可），这样通过 token 获取用户名即可拿到权限数据，这样就可构成出完整的 Authentication 对象。</p>
<h4 id="31-修改loaduserbyusername接口方法"><a class="markdownIt-Anchor" href="#31-修改loaduserbyusername接口方法">#</a> 3.1、修改 loadUserByUsername 接口方法</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">    <span class="type">SysUser</span> <span class="variable">sysUser</span> <span class="operator">=</span> sysUserService.getByUsername(username);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == sysUser) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;用户名不存在！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(sysUser.getStatus().intValue() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ACCOUNT_STOP);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; userPermsList = sysMenuService.findUserPermsList(sysUser.getId());</span><br><span class="line">    List&lt;SimpleGrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String perm : userPermsList) &#123;</span><br><span class="line">        authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(perm.trim()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomUser</span>(sysUser, authorities);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="32-spring-security模块配置redis"><a class="markdownIt-Anchor" href="#32-spring-security模块配置redis">#</a> 3.2、spring-security 模块配置 redis</h4>
<p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="33-修改tokenloginfilter登录成功方法"><a class="markdownIt-Anchor" href="#33-修改tokenloginfilter登录成功方法">#</a> 3.3、修改 TokenLoginFilter 登录成功方法</h4>
<p>登录成功我们将权限数据保单到 reids</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenLoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TokenLoginFilter</span><span class="params">(AuthenticationManager authenticationManager, RedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setAuthenticationManager(authenticationManager);</span><br><span class="line">        <span class="built_in">this</span>.setPostOnly(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//指定登录接口及提交方式，可以指定任意路径</span></span><br><span class="line">        <span class="built_in">this</span>.setRequiresAuthenticationRequestMatcher(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/admin/system/index/login&quot;</span>,<span class="string">&quot;POST&quot;</span>));</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录认证</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> res</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> AuthenticationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span></span><br><span class="line">            <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">LoginVo</span> <span class="variable">loginVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().readValue(req.getInputStream(), LoginVo.class);</span><br><span class="line"></span><br><span class="line">            <span class="type">Authentication</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginVo.getUsername(), loginVo.getPassword());</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authenticationToken);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录成功</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chain</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain,</span></span><br><span class="line"><span class="params">                                            Authentication auth)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">CustomUser</span> <span class="variable">customUser</span> <span class="operator">=</span> (CustomUser) auth.getPrincipal();</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JwtHelper.createToken(customUser.getSysUser().getId(), customUser.getSysUser().getUsername());</span><br><span class="line">        <span class="comment">//保存权限数据</span></span><br><span class="line">        redisTemplate.opsForValue().set(customUser.getUsername(), JSON.toJSONString(customUser.getAuthorities()));</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">        ResponseUtil.out(response, Result.ok(map));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录失败</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">unsuccessfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                              AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(e.getCause() <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            ResponseUtil.out(response, Result.build(<span class="literal">null</span>, <span class="number">204</span>, e.getMessage()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ResponseUtil.out(response, Result.build(<span class="literal">null</span>, ResultCodeEnum.LOGIN_MOBLE_ERROR));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="34-修改tokenauthenticationfilter"><a class="markdownIt-Anchor" href="#34-修改tokenauthenticationfilter">#</a> 3.4、修改 TokenAuthenticationFilter</h4>
<p>认证是从 redis 里面获取权限数据</p>
<p>完整代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.fillter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.jwt.JwtHelper;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.result.ResultCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.util.ResponseUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 认证解析token过滤器</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TokenAuthenticationFilter</span><span class="params">(RedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;uri:&quot;</span>+request.getRequestURI());</span><br><span class="line">        <span class="comment">//如果是登录接口，直接放行</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;/admin/system/index/login&quot;</span>.equals(request.getRequestURI())) &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authentication</span> <span class="operator">=</span> getAuthentication(request);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != authentication) &#123;</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ResponseUtil.out(response, Result.build(<span class="literal">null</span>, ResultCodeEnum.PERMISSION));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UsernamePasswordAuthenticationToken <span class="title function_">getAuthentication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// token置于header里</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;token:&quot;</span>+token);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> JwtHelper.getUsername(token);</span><br><span class="line">            logger.info(<span class="string">&quot;useruame:&quot;</span>+username);</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(username)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">authoritiesString</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(useruame);</span><br><span class="line">                List&lt;Map&gt; mapList = JSON.parseArray(authoritiesString, Map.class);</span><br><span class="line">                List&lt;SimpleGrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                <span class="keyword">for</span> (Map map : mapList) &#123;</span><br><span class="line">                    authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>((String)map.get(<span class="string">&quot;authority&quot;</span>)));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(useruame, <span class="literal">null</span>, authorities);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="35-修改配置类"><a class="markdownIt-Anchor" href="#35-修改配置类">#</a> 3.5、修改配置类</h4>
<p>修改 WebSecurityConfig 类</p>
<p>配置类添加注解：</p>
<p>开启基于方法的安全认证机制，也就是说在 web 层的 controller 启用注解机制的安全确认</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br></pre></td></tr></table></figure>
<p>添加注入 bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br></pre></td></tr></table></figure>
<p>添加参数：</p>
<p>连个 fillter 添加 redisTemplate 参数</p>
<p><strong>完整代码如下：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.security.custom.CustomMd5PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.security.fillter.TokenAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.security.fillter.TokenLoginFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span> <span class="comment">//@EnableWebSecurity是开启SpringSecurity的默认行为</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span><span class="comment">//开启注解功能，默认禁用注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomMd5PasswordEncoder customMd5PasswordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 这是配置的关键，决定哪些接口开启防护，哪些接口绕过防护</span></span><br><span class="line">        http</span><br><span class="line">                <span class="comment">//关闭csrf</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line">                <span class="comment">// 开启跨域以便前端调用接口</span></span><br><span class="line">                .cors().and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                <span class="comment">// 指定某些接口不需要通过验证即可访问。登陆接口肯定是不需要认证的</span></span><br><span class="line">                <span class="comment">//.antMatchers(&quot;/admin/system/index/login&quot;).permitAll()</span></span><br><span class="line">                <span class="comment">// 这里意思是其它所有接口需要认证才能访问</span></span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">//TokenAuthenticationFilter放到UsernamePasswordAuthenticationFilter的前面，这样做就是为了除了登录的时候去查询数据库外，其他时候都用token进行认证。</span></span><br><span class="line">                .addFilterBefore(<span class="keyword">new</span> <span class="title class_">TokenAuthenticationFilter</span>(redisTemplate), UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">                .addFilter(<span class="keyword">new</span> <span class="title class_">TokenLoginFilter</span>(authenticationManager(), redisTemplate));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//禁用session</span></span><br><span class="line">        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 指定UserDetailService和加密器</span></span><br><span class="line">        auth.userDetailsService(userDetailsService).passwordEncoder(customMd5PasswordEncoder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置哪些请求不拦截</span></span><br><span class="line"><span class="comment">     * 排除swagger相关请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/favicon.ico&quot;</span>,<span class="string">&quot;/swagger-resources/**&quot;</span>, <span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;/v2/**&quot;</span>, <span class="string">&quot;/swagger-ui.html/**&quot;</span>, <span class="string">&quot;/doc.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="36-service-oa模块添加redis配置"><a class="markdownIt-Anchor" href="#36-service-oa模块添加redis配置">#</a> 3.6、service-oa 模块添加 redis 配置</h4>
<p>application-dev.yml 配文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">password:</span></span><br><span class="line">    <span class="attr">jedis:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">20</span> <span class="comment">#最大连接数</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="number">-1</span>    <span class="comment">#最大阻塞等待时间(负数表示没限制)</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">5</span>    <span class="comment">#最大空闲</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span>     <span class="comment">#最小空闲</span></span><br></pre></td></tr></table></figure>
<h4 id="37-控制controller层接口权限"><a class="markdownIt-Anchor" href="#37-控制controller层接口权限">#</a> 3.7、控制 controller 层接口权限</h4>
<p><strong>Spring Security 默认是禁用注解的，要想开启注解，需要在继承 WebSecurityConfigurerAdapter 的类上加 @EnableGlobalMethodSecurity 注解，来判断用户对某个控制层的方法是否具有访问权限</strong></p>
<p>通过 @PreAuthorize 标签控制 controller 层接口权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysRoleController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysRoleService sysRoleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.list&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;获取分页列表&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&#123;page&#125;/&#123;limit&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">index</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@ApiParam(name = &quot;page&quot;, value = &quot;当前页码&quot;, required = true)</span></span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> Long page,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">            <span class="meta">@ApiParam(name = &quot;limit&quot;, value = &quot;每页记录数&quot;, required = true)</span></span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> Long limit,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">            <span class="meta">@ApiParam(name = &quot;roleQueryVo&quot;, value = &quot;查询对象&quot;, required = false)</span></span></span><br><span class="line"><span class="params">                    SysRoleQueryVo roleQueryVo)</span> &#123;</span><br><span class="line">        Page&lt;SysRole&gt; pageParam = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(page, limit);</span><br><span class="line">        IPage&lt;SysRole&gt; pageModel = sysRoleService.selectPage(pageParam, roleQueryVo);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(pageModel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.list&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;获取&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">get</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">SysRole</span> <span class="variable">role</span> <span class="operator">=</span> sysRoleService.getById(id);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(role);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.add&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;新增角色&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> SysRole role)</span> &#123;</span><br><span class="line">        sysRoleService.save(role);</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.update&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;修改角色&quot;)</span></span><br><span class="line">    <span class="meta">@PutMapping(&quot;update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">updateById</span><span class="params">(<span class="meta">@RequestBody</span> SysRole role)</span> &#123;</span><br><span class="line">        sysRoleService.updateById(role);</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.remove&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;删除角色&quot;)</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;remove/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">remove</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        sysRoleService.removeById(id);</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.remove&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;根据id列表删除&quot;)</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;batchRemove&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">batchRemove</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;Long&gt; idList)</span> &#123;</span><br><span class="line">        sysRoleService.removeByIds(idList);</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="38-测试服务器端权限"><a class="markdownIt-Anchor" href="#38-测试服务器端权限">#</a> 3.8、测试服务器端权限</h4>
<p>登录后台，分配权限进行测试，页面如果添加了按钮权限控制，可临时去除方便测试</p>
<p>测试结论：</p>
<p>​	1、分配了权限的能够成功返回接口数据</p>
<p>​	2、没有分配权限的会抛出异常：org.springframework.security.access.AccessDeniedException: 不允许访问</p>
<h4 id="39-异常处理"><a class="markdownIt-Anchor" href="#39-异常处理">#</a> 3.9、异常处理</h4>
<p>异常处理有 2 种方式：</p>
<p>​	1、扩展 Spring Security 异常处理类：AccessDeniedHandler、AuthenticationEntryPoint</p>
<p>​	2、在 spring boot 全局异常统一处理</p>
<p><strong>第一种方案说明：如果系统实现了全局异常处理，那么全局异常首先会获取 AccessDeniedException 异常，要想 Spring Security 扩展异常生效，必须在全局异常再次抛出该异常。</strong></p>
<p><strong>我们使用第二种方案。</strong></p>
<p><strong>全局异常添加处理</strong></p>
<p>操作模块：service-util</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * spring security异常</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ExceptionHandler(AccessDeniedException.class)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">error</span><span class="params">(AccessDeniedException e)</span> <span class="keyword">throws</span> AccessDeniedException &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.build(<span class="literal">null</span>, ResultCodeEnum.PERMISSION);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AccessDeniedException 需要引入依赖，Spring Security 对应的异常</p>
<p>在 service-util 模块引入依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</div><div class="sharethis-inline-share-buttons"></div><script src="https://brath.cn" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/07/06/6-2.%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-%E5%89%8D%E7%AB%AF%E6%9D%83%E9%99%90%E5%AF%B9%E6%8E%A5/"><i class="level-item fas fa-chevron-left"></i><span class="level-item"> </span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/07/06/5.%E8%8F%9C%E5%8D%95%E7%AE%A1%E7%90%86/"><span class="level-item"> </span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-06T08:39:47.642Z">2023-07-06</time></p><p class="title"><a href="/2023/07/06/2.%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-06T08:39:47.640Z">2023-07-06</time></p><p class="title"><a href="/2023/07/06/1.%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-06T08:39:47.638Z">2023-07-06</time></p><p class="title"><a href="/2023/07/06/12.%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-06T08:39:47.636Z">2023-07-06</time></p><p class="title"><a href="/2023/07/06/11.%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-06T08:39:47.634Z">2023-07-06</time></p><p class="title"><a href="/2023/07/06/10.%E5%89%8D%E7%AB%AF%E5%AE%A1%E6%89%B9/"> </a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li></ul></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://moon-sea.oss-cn-shanghai.aliyuncs.com/blog_images/head.png" alt="beibei"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">beibei</p><p class="is-size-6 is-block">自信，向阳生长。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·江苏·无锡</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">16</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/zhengyaok" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zhengyaok"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://gitee.com/Guoqing-Li" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee(码云)</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/Brath?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://juejin.cn/user/settings/profile" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.cn</span></span></a></li><li><a class="level is-mobile" href="https://oss.console.aliyun.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">AliCloud(阿里云)</span></span><span class="level-right"><span class="level-item tag">oss.console.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://cloud.tencent.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TencentCloud(腾讯云)</span></span><span class="level-right"><span class="level-item tag">cloud.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhipin.com/web/user/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">BOSS</span></span><span class="level-right"><span class="level-item tag">www.zhipin.com</span></span></a></li><li><a class="level is-mobile" href="https://www.bilibili.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bilibili(B站)</span></span><span class="level-right"><span class="level-item tag">www.bilibili.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://moon-sea.oss-cn-shanghai.aliyuncs.com/blog_images/head.png" alt="BeiBei-Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p><p class="is-size-7">© 2030</p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>